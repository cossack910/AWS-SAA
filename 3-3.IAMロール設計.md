### ケーススタディ

システムの設計から AWS サービス間の連携有無を抽出する。→ 必要な権限設定の割り出しを実施

| システム                                       | 必要権限                                     |
| ---------------------------------------------- | -------------------------------------------- |
| EC2 インスタンスがバッチ処理で S3 にデータ保存 | EC2 インスタンスに S3 へのアクセス権限を設定 |

実際にやることは IAM ロール付与のみなので EC2 は適当。<br>

#### 手で設定する場合の手順

- 1 EC2 インスタンスを作成
- 2 S3 のフルアクセスポリシーを作成<br>
- 3 EC2 に付与するためのロールを作成。
  - 3-1 信頼エンティティは EC2 を選択 (信頼ポリシー)
  - 2-2 許可ポリシーは 2 で作成した S3 のフルアクセスポリシーを許可
- 4 3 で作成したロールを EC2 に付与して完了

以下、Cfn の設定

```
Cfn/casestudy-iam-role.yml
```

**tips**

### インスタンスプロファイル

Cfn 設定時にインスタンスプロファイルが曖昧だったので、以下公式説明

```
Amazon EC2 は、IAM ロールのコンテナとしてインスタンスプロファイルを使用します。IAM コンソールを使用して IAM ロールを作成すると、コンソールによりインスタンスプロファイルが自動的に作成され、対応するロールと同じ名前が付けられます。
Amazon EC2 コンソールを使用して IAM ロールを持つインスタンスを起動する場合、またはインスタンスに IAM ロールをアタッチする場合は、インスタンスプロファイル名のリストに基づいてロールを選択します。

AWS CLI、API、または AWS SDK を使用してロールを作成する場合、ロールとインスタンスプロファイルを別個のアクションとして作成します。名前は異なる可能性があります。
次に AWS CLI、API、または AWS SDK を使用して IAM ロールを持つインスタンスを起動する場合、またはインスタンスに IAM ロールをアタッチする場合は、インスタンスプロファイル名を指定します。

インスタンスプロファイルに含めることができる IAM ロールの数は 1 つのみです。この制限を増やすことはできません。
```

インスタンスプロファイルの詳細
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html

### 実際にアクセス

鍵の権限を 400 にかえる

```
chmod 400 [秘密鍵のファイルパス]
```

ssh でログイン

```
ssh -i [秘密鍵のファイルパス] [ユーザー名]@[サーバーのアドレス] -p [ポート番号]
```

以下のコマンドで S3 一覧が確認できれば OK

```
aws s3 ls
```
